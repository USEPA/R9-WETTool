{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block extrahead %}{{ block.super }}

    <script type="text/javascript" src="{% url 'admin:jsi18n' %}"></script>

    {{ media }}

    <script src="https://unpkg.com/ag-grid-community/dist/ag-grid-community.min.js"></script>


    {#   ESRI stuff has to come after the media tag#}
    <script type="text/javascript" src="https://js.arcgis.com/4.16/"></script>
    <link rel="stylesheet" href="https://js.arcgis.com/4.16/esri/css/main.css">
    <script>
        (function ($) {
            document.addEventListener('DOMContentLoaded', () => {
                var csrf = document.getElementsByName('csrfmiddlewaretoken')[0].value;

                // Load the Map and MapView modules
                require(["esri/Map", "esri/views/MapView", "esri/widgets/Sketch", "esri/layers/FeatureLayer",
                        "esri/layers/GraphicsLayer", "esri/Graphic", "esri/geometry/projection", "esri/geometry/Point", "esri/layers/VectorTileLayer",
                        'esri/core/urlUtils', 'esri/config', "esri/widgets/Fullscreen", "esri/widgets/FeatureTable"],
                    function (Map, MapView, Sketch, FeatureLayer, GraphicsLayer, Graphic, projection, Point, VectorTileLayer,
                              urlUtils, esriConfig, Fullscreen, FeatureTable) {
                        esriConfig.request.trustedServers.push('http://127.0.0.1:8000');
                        urlUtils.addProxyRule({
                            urlPrefix: 'services.arcgis.com/cJ9YHowT8TU7DUyn',
                            proxyUrl: 'http://127.0.0.1:8000/proxy/'
                        });
                        esriConfig.request.interceptors.push({
                            urls: ['https://services.arcgis.com/cJ9YHowT8TU7DUyn'],
                            headers: {
                                "X-CSRFToken": csrf
                            }
                        });
                        var tempGraphicsLayer = new GraphicsLayer();
                        var references = new VectorTileLayer("https://www.arcgis.com/sharing/rest/content/items/af6063d6906c4eb589dfe03819610660/resources/styles/root.json");

                        var editGraphic;
                        var allFeatures = [];

                        //var projectionPromise = projection.load();

                        // Create a MapView instance (for 2D viewing) and reference the map instance


                        if (document.getElementById('id_base_map_service').value) {
                            var base_service = document.getElementById('id_base_map_service').value;
                            {# todo: figure out how to id the correct layer #}
                            var fl = new FeatureLayer({
                                url: base_service + "/1"
                            })
                            // Create a Map instance
                            var myMap = new Map({
                                basemap: 'satellite',
                                layers: [references, fl, tempGraphicsLayer]
                            });
                            var view = new MapView({
                                map: myMap,
                                container: 'mapDiv'
                            });
                            fl.when(function () {
                                view.extent = fl.fullExtent;
                                getFeatures();
                            });
                            const sketch = new Sketch({
                                layer: tempGraphicsLayer,
                                view: view,
                                availableCreateTools: ["polygon", "rectangle", "circle"]
                                // graphic will be selected as soon as it is created
                                //creationMode: "update"
                            });

                            /* once FeatureTable has more features and is out of beta it might be worth it
                            const featureTable = new FeatureTable({
                              view: view, // The view property must be set for the select/highlight to work
                              layer: fl,
                              container: "featuresTable"
                            });*/

                            sketch.on('update', e => {
                                $('#mapDiv button:not([type])').attr('type', 'button')
                                if (e.state === 'complete' && !e.aborted) {
                                    selectFeaturesByGeometry(e.graphics[0].geometry, false);
                                }
                            });
                            sketch.on('create', e => {
                                if (e.state === 'complete') {
                                    selectFeaturesByGeometry(e.graphic.geometry, false);
                                }
                            })
                            sketch.on('delete', e => {
                                selectFeaturesByGeometry(e.graphics[0].geometry, true);
                            })
                            const fullscreen = new Fullscreen({
                                view: view
                            });

                            view.ui.add(sketch, "top-right");
                            view.on("immediate-click", event => {
                                view.hitTest(event).then(response => {
                                    const candidate = response.results.find(result => {
                                        return (
                                            result.graphic &&
                                            result.graphic.layer &&
                                            result.graphic.layer === fl
                                        );
                                    });
                                    // Select the rows of the clicked feature
                                    var current_selection = getCurrentSelection();
                                    var remove = current_selection.includes(candidate.graphic.attributes.OBJECTID);
                                    candidate && selectFeatures([candidate.graphic.attributes.OBJECTID], remove);
                                });
                            });
                            view.when(function () {
                                $('#mapDiv button:not([type])').attr('type', 'button');
                                //$('#featuresTable button:not([type])').attr('type', 'button');
                                // apears to select by objectid
                                //featureTable.selectRows([336, 326]);
                            });
                            view.whenLayerView(fl).then(layerView => console.log(layerView));
                        }

                        var gridOptions;

                        function getFeatures() {
                            fl.queryFeatures({"where": "1=1", "outFields": "*"}).then(function (featureSet) {
                                // todo: deal with getting more features if max returned
                                allFeatures = allFeatures.concat(featureSet.features);
                                var features = featureSet.features.map(f => f.attributes);
                                var columnDefs = featureSet.fields
                                //.filter(f => ! ['OBJECTID','created_date', 'created_user', 'last_edited_user', 'last_edited_date'].includes(f.name))
                                    .map(f => {
                                        var columnDef = {"headerName": f.alias, "field": f.name};
                                        if (['OBJECTID', 'created_date', 'created_user', 'last_edited_user', 'last_edited_date'].includes(f.name)) {
                                            columnDef['hide'] = true
                                        }
                                        return columnDef;
                                    })
                                gridOptions = {
                                    defaultColDef: {
                                        flex: 1,
                                        sortable: true,
                                        filter: true,
                                        floatingFilter: true,
                                    },
                                    rowSelection: 'multiple',
                                    rowMultiSelectWithClick: true,
                                    columnDefs: columnDefs,
                                    rowData: features,
                                    onFirstDataRendered: function (e) {
                                        e.columnApi.autoSizeAllColumns();
                                        highlightFeatures();
                                    },
                                    onRowClicked: function (e) {
                                        selectFeatures([e.node.data.OBJECTID], !e.node.isSelected())
                                    }
                                }
                                var gridDiv = document.querySelector('#featuresTable');
                                new agGrid.Grid(gridDiv, gridOptions);

                            });

                        }

                        function selectFeaturesByGeometry(geometry, remove) {
                            fl.queryObjectIds({geometry, spatialRelationship: 'contains'}).then(function (ids) {
                                selectFeatures(ids, remove);
                            });
                        }

                        function selectFeatures(ids, remove) {
                            var current_selection = getCurrentSelection();
                            if (remove) {
                                var new_selection = current_selection.filter(id => !ids.includes(id))
                            } else {
                                var new_selection = new Set(current_selection.concat(ids));
                            }
                            document.getElementById('id_selected_features').value = [...new_selection].join(',');
                            highlightFeatures();
                        }

                        var highlight;

                        function highlightFeatures() {
                            var current_selection = getCurrentSelection();
                            gridOptions.api.forEachNode(function (node) {
                                node.setSelected(current_selection.includes(node.data.OBJECTID));
                            });

                            view.whenLayerView(fl).then(layerView => {
                                if (highlight) {
                                    highlight.remove();
                                }
                                var selected_features = allFeatures.filter(f => current_selection.includes(f.attributes.OBJECTID))
                                highlight = layerView.highlight(selected_features);
                            });
                        }

                        function getCurrentSelection() {
                            return document.getElementById('id_selected_features').value
                                .split(',')
                                .filter(id => id !== "")
                                .map(id => parseInt(id, 10))
                        }

                    });
            });
        })(django.jQuery);
    </script>
{% endblock %}

{% block extrastyle %}{{ block.super }}
    <link rel="stylesheet" type="text/css" href="{% static "admin/css/forms.css" %}"/>{% endblock %}

{% block coltype %}colM{% endblock %}

{% block bodyclass %}{{ block.super }} app-{{ opts.app_label }} model-{{ opts.model_name }} change-form{% endblock %}

{% if not is_popup %}
    {% block breadcrumbs %}
        <div class="breadcrumbs">
            <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
            &rsaquo; <a
                href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
            &rsaquo; {% if has_change_permission %}
            <a href="{% url opts|admin_urlname:'changelist' %}">{{ opts.verbose_name_plural|capfirst }}</a>{% else %}
            {{ opts.verbose_name_plural|capfirst }}{% endif %}
            &rsaquo; {% if add %}{% blocktrans with name=opts.verbose_name %}Add {{ name }}{% endblocktrans %}{% else %}
            {{ original|truncatewords:"18" }}{% endif %}
        </div>
    {% endblock %}
{% endif %}

{% block content %}
    <div id="content-main">
        {% block object-tools %}
            {% if change %}{% if not is_popup %}
                <ul class="object-tools">
                    {% block object-tools-items %}
                        <li>
                            {% url opts|admin_urlname:'history' original.pk|admin_urlquote as history_url %}
                            <a href="{% add_preserved_filters history_url %}"
                               class="historylink">{% trans "History" %}</a>
                        </li>
                        {% if has_absolute_url %}
                            <li><a href="{{ absolute_url }}" class="viewsitelink">{% trans "View on site" %}</a></li>
                        {% endif %}
                    {% endblock %}
                </ul>
            {% endif %}{% endif %}
        {% endblock %}
        <form {% if has_file_field %}enctype="multipart/form-data" {% endif %}action="{{ form_url }}" method="post"
              id="{{ opts.model_name }}_form" novalidate>{% csrf_token %}{% block form_top %}{% endblock %}
            <div>
                {% if is_popup %}<input type="hidden" name="{{ is_popup_var }}" value="1"/>{% endif %}
                {% if to_field %}<input type="hidden" name="{{ to_field_var }}" value="{{ to_field }}"/>{% endif %}
                {% if save_on_top %}{% block submit_buttons_top %}{% submit_row %}{% endblock %}{% endif %}
                {% if errors %}
                    <p class="errornote">
                        {% if errors|length == 1 %}{% trans "Please correct the error below." %}{% else %}
                            {% trans "Please correct the errors below." %}{% endif %}
                    </p>
                    {{ adminform.form.non_field_errors }}
                {% endif %}

                {% block field_sets %}
                    <div style="display: flex; flex-direction: row;">
                        <style>
                            fieldset {
                                min-width: 50%;
                            }
                        </style>
                        {% for fieldset in adminform %}
                            {% if fieldset.name != 'Location' and fieldset.name != 'Audit Information' %}
                                {% include "admin/includes/fieldset.html" %}
                            {% endif %}
                        {% endfor %}
                        <div style="height: 500px; min-width: 50%">
                            <div id="mapDiv" style="height: 500px; min-width: 100%;"></div>
                        </div>
                    </div>
                {% endblock %}

                {% block after_field_sets %}
                    <fieldset class="module" style="height: 500px;">
                        <h2>AVAILABLE FEATURES</h2>
                        <div id="featuresTable" style="height: 500px; overflow-x: auto;" class="ag-theme-balham"></div>
                    </fieldset>
                {% endblock %}

                {% block inline_field_sets %}
                    {% for inline_admin_formset in inline_admin_formsets %}
                        {% include inline_admin_formset.opts.template %}
                    {% endfor %}
                {% endblock %}

                {% block after_related_objects %}{% endblock %}

                {% block submit_buttons_bottom %}
{#                    <div class="submit-row">#}
{#                        <input type="submit" value="Submit Base Data to Survey123">#}
{#                        <input type="submit" value="Generate XLS Sheet">#}
{#                    </div>#}
                    {% submit_row %}{% endblock %}

                {% block admin_change_form_document_ready %}
                    <script type="text/javascript"
                            id="django-admin-form-add-constants"
                            src="{% static 'admin/js/change_form.js' %}"
                            {% if adminform and add %}
                            data-model-name="{{ opts.model_name }}"
                            {% endif %}>
                    </script>
                {% endblock %}

                {# JavaScript for prepopulated fields #}
                {% prepopulated_fields_js %}

            </div>
        </form>
    </div>

{% endblock %}
